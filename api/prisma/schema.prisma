generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Agent status tracking
model AgentStatus {
  id          String   @id @default(uuid())
  agentId     String   @unique
  name        String
  role        String
  emoji       String
  department  String?
  location    String   // "Mac Studio HQ" or "Luna Labs VPS"
  
  status      String   // "working", "idle", "blocked", "completed"
  currentTask String?
  progress    Int?     // 0-100
  blockers    String[] @default([])
  
  lastUpdate  DateTime @default(now())
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  statusHistory StatusHistory[]
  
  @@index([agentId])
  @@index([department])
  @@index([status])
  @@index([location])
}

// Status change history
model StatusHistory {
  id            String   @id @default(uuid())
  agentStatusId String
  agentId       String
  
  status        String
  currentTask   String?
  progress      Int?
  blockers      String[] @default([])
  
  timestamp     DateTime @default(now())
  metadata      Json     @default("{}")
  
  agentStatus   AgentStatus @relation(fields: [agentStatusId], references: [id], onDelete: Cascade)
  
  @@index([agentId])
  @@index([timestamp])
}

// Projects
model Project {
  id            String   @id @default(uuid())
  name          String   @unique
  code          String?  @unique // e.g., "p3-019"
  description   String?
  owner         String   // agentId of owner
  status        String   // "active", "paused", "completed", "archived"
  progress      Int      @default(0) // 0-100
  location      String?  // File path
  
  nextMilestone String?
  blockers      String[] @default([])
  
  startDate     DateTime?
  targetDate    DateTime?
  completedDate DateTime?
  
  tags          String[] @default([])
  metadata      Json     @default("{}")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  tasks         Task[]
  
  @@index([owner])
  @@index([status])
}

// Departments/Teams
model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  headAgentId String?  // Department head agent ID
  location    String   // "Mac Studio HQ" or "Luna Labs VPS"
  
  agentCount  Int      @default(0)
  
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([name])
}

// Tasks (Command Center)
model Task {
  id            String    @id @default(uuid())
  title         String
  description   String?
  status        String    @default("backlog") // "recurring", "backlog", "progress", "done"
  priority      String    @default("medium")  // "low", "medium", "high", "urgent"
  
  agentId       String?   // Owner agent
  projectId     String?
  cronJobId     String?   // Link to cron if recurring
  createdBy     String?
  
  progress      Int       @default(0) // 0-100
  dueDate       DateTime?
  completedAt   DateTime?
  
  tags          String[]  @default([])
  metadata      Json      @default("{}")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  project       Project?  @relation(fields: [projectId], references: [id])
  
  @@index([status])
  @@index([agentId])
  @@index([projectId])
}

// Activity Log
model ActivityLog {
  id          String   @id @default(uuid())
  type        String   // "task", "commit", "message", "project", "agent", "system"
  agentId     String?
  projectId   String?
  taskId      String?
  
  title       String
  description String?
  metadata    Json     @default("{}")
  
  createdAt   DateTime @default(now())
  
  @@index([type])
  @@index([agentId])
  @@index([createdAt])
}
